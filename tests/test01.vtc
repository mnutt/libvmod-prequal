varnishtest "Test prequal director backend selection and health"

server s1 -repeat 10 {
	rxreq
	expect req.url == "/probe"
	txresp \
		-hdr "X-In-Flight: 5" \
		-hdr "X-Estimated-Latency: 100" \
		-body "OK"
} -start

server s2 -repeat 10 {
	rxreq
	expect req.url == "/probe"
	txresp \
		-hdr "X-In-Flight: 10" \
		-hdr "X-Estimated-Latency: 200" \
		-body "OK"
} -start

varnish v1 -vcl+backend {
	import prequal from "${vmod}";

	sub vcl_init {
		new dir = prequal.director();
		dir.add_backend(s1);
		dir.add_backend(s2);
		dir.seed_probes();
	}

	sub vcl_recv {
		set req.backend_hint = dir.backend();
		set req.http.backend_name = req.backend_hint;
		return(pass);
	}

	sub vcl_deliver {
		set resp.http.healthy = dir.healthy();
	}
} -start

delay 0.5

client c1 {
	txreq -url /probe
	rxresp
	expect resp.http.healthy == "true"
	expect resp.status == 200
	expect resp.body ~ "OK"
} -run

client c2 {
	txreq -url /probe
	rxresp
	expect resp.http.healthy == "true"
	expect resp.status == 200
	expect resp.body ~ "OK"
} -run
